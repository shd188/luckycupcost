# 幸运咖产品成本计算器 - 开发流程图

## 一、系统初始化流程

```
┌─────────────────┐
│  小程序启动      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  onLoad()       │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐ ┌────────┐
│拉取    │ │拉取    │
│materials│ │products│
└───┬────┘ └───┬────┘
    │         │
    └────┬────┘
         │
         ▼
┌─────────────────┐
│ 构建materialsMap │
│ (提高查找效率)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 计算所有产品成本 │
│ (实时计算)       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 渲染首页列表     │
└─────────────────┘
```

## 二、搜索功能流程

```
┌─────────────────┐
│  用户输入关键词  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ onSearchInput() │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 关键词转小写     │
│ keyword.toLowerCase()│
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐ ┌────────┐
│搜索产品 │ │搜索物料 │
│name匹配 │ │name匹配 │
└───┬────┘ └───┬────┘
    │         │
    │         ▼
    │    ┌────────────┐
    │    │计算单位成本 │
    │    │unitPrice   │
    │    └────────────┘
    │         │
    ▼         ▼
┌─────────────────┐
│ 合并搜索结果     │
│ productResults  │
│ materialResults │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 更新页面显示     │
└─────────────────┘
```

## 三、产品成本计算流程

```
┌─────────────────┐
│  点击产品项      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 获取产品数据     │
│ product.recipe  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 遍历 recipe[]   │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐ ┌────────┐
│获取    │ │查找    │
│material_id│ │materialsMap│
└───┬────┘ └───┬────┘
    │         │
    └────┬────┘
         │
         ▼
┌─────────────────┐
│ 计算单位成本     │
│ unitPrice =     │
│ spec_price /    │
│ spec_amount     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 计算单项成本     │
│ itemCost =      │
│ amount ×        │
│ unitPrice       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 累加到总成本     │
│ totalCost +=    │
│ itemCost        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 记录成本明细     │
│ details[]       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 格式化显示       │
│ toFixed(2)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 渲染详情页       │
└─────────────────┘
```

## 四、数据更新流程

```
┌─────────────────┐
│  管理员修改      │
│ 物料价格         │
│ (云控制台)       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 更新 materials  │
│ spec_price      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  用户重新进入    │
│  小程序          │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ onLoad()        │
│ 拉取最新数据     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 自动重新计算     │
│ 所有产品成本     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 所有产品自动     │
│ 刷新显示         │
└─────────────────┘
```

## 五、核心代码结构

### 5.1 首页 (index.js)

```javascript
Page({
  data: {
    searchKeyword: '',
    allProducts: [],
    allMaterials: [],
    materialsMap: {},        // 物料索引Map
    productResults: [],
    materialResults: [],
    hasNoResult: false
  },

  onLoad() {
    this.loadData();
  },

  // 加载数据
  async loadData() {
    try {
      // 1. 拉取物料
      const materials = await this.loadMaterials();
      
      // 2. 构建Map索引
      this.buildMaterialsMap(materials);
      
      // 3. 拉取产品
      const products = await this.loadProducts();
      
      // 4. 计算所有产品成本
      this.calculateAllProducts(products);
      
      // 5. 初始显示所有产品
      this.setData({
        productResults: this.data.allProducts,
        materialResults: this.data.allMaterials
      });
    } catch (error) {
      console.error('加载数据失败:', error);
      wx.showToast({
        title: '加载失败',
        icon: 'none'
      });
    }
  },

  // 拉取物料数据
  loadMaterials() {
    return new Promise((resolve, reject) => {
      const db = wx.cloud.database();
      db.collection('materials')
        .get()
        .then(res => {
          const materials = res.data.map(m => ({
            ...m,
            unitPrice: this.calculateUnitPrice(m)
          }));
          this.setData({ allMaterials: materials });
          resolve(materials);
        })
        .catch(reject);
    });
  },

  // 拉取产品数据
  loadProducts() {
    return new Promise((resolve, reject) => {
      const db = wx.cloud.database();
      db.collection('products')
        .get()
        .then(res => {
          this.setData({ allProducts: res.data });
          resolve(res.data);
        })
        .catch(reject);
    });
  },

  // 构建物料Map索引
  buildMaterialsMap(materials) {
    const map = {};
    materials.forEach(m => {
      map[m._id] = m;
    });
    this.setData({ materialsMap: map });
  },

  // 计算所有产品成本
  calculateAllProducts(products) {
    const { materialsMap } = this.data;
    const calculatedProducts = products.map(product => {
      const costInfo = this.calculateProductCost(product, materialsMap);
      return {
        ...product,
        totalCost: costInfo.totalCost
      };
    });
    this.setData({ allProducts: calculatedProducts });
  },

  // 计算单位成本
  calculateUnitPrice(material) {
    return parseFloat((material.spec_price / material.spec_amount).toFixed(4));
  },

  // 计算产品成本
  calculateProductCost(product, materialsMap) {
    let totalCost = 0;
    const details = [];

    product.recipe.forEach(item => {
      const material = materialsMap[item.material_id];
      if (!material) return;

      const unitPrice = this.calculateUnitPrice(material);
      const itemCost = item.amount * unitPrice;

      totalCost += itemCost;
      details.push({
        materialName: material.name,
        amount: item.amount,
        unit: material.spec_unit,
        unitPrice: unitPrice,
        itemCost: parseFloat(itemCost.toFixed(2))
      });
    });

    return {
      totalCost: parseFloat(totalCost.toFixed(2)),
      details: details
    };
  },

  // 搜索输入
  onSearchInput(e) {
    const keyword = e.detail.value;
    this.setData({ searchKeyword: keyword });
    this.search(keyword);
  },

  // 执行搜索
  search(keyword) {
    if (!keyword.trim()) {
      // 空搜索，显示全部
      this.setData({
        productResults: this.data.allProducts,
        materialResults: this.data.allMaterials,
        hasNoResult: false
      });
      return;
    }

    const keywordLower = keyword.toLowerCase();
    const { allProducts, allMaterials, materialsMap } = this.data;

    // 搜索产品
    const productResults = allProducts
      .filter(p => p.name.toLowerCase().includes(keywordLower));

    // 搜索物料
    const materialResults = allMaterials
      .filter(m => m.name.toLowerCase().includes(keywordLower));

    this.setData({
      productResults,
      materialResults,
      hasNoResult: productResults.length === 0 && materialResults.length === 0
    });
  },

  // 跳转到产品详情
  goToProductDetail(e) {
    const product = e.currentTarget.dataset.item;
    wx.navigateTo({
      url: `/pages/detail/detail?type=product&id=${product._id}`
    });
  },

  // 跳转到物料详情
  goToMaterialDetail(e) {
    const material = e.currentTarget.dataset.item;
    wx.navigateTo({
      url: `/pages/detail/detail?type=material&id=${material._id}`
    });
  }
});
```

### 5.2 详情页 (detail.js)

```javascript
Page({
  data: {
    type: '',              // 'product' 或 'material'
    product: null,
    material: null,
    costInfo: null,        // 产品成本信息
    unitPrice: 0,          // 物料单位成本
    materialsMap: {}       // 物料索引Map
  },

  onLoad(options) {
    const { type, id } = options;
    this.setData({ type });
    
    // 先加载物料数据（用于产品成本计算）
    this.loadMaterials().then(() => {
      if (type === 'product') {
        this.loadProduct(id);
      } else if (type === 'material') {
        this.loadMaterial(id);
      }
    });
  },

  // 加载物料数据
  loadMaterials() {
    return new Promise((resolve, reject) => {
      const db = wx.cloud.database();
      db.collection('materials')
        .get()
        .then(res => {
          const map = {};
          res.data.forEach(m => {
            map[m._id] = m;
          });
          this.setData({ materialsMap: map });
          resolve();
        })
        .catch(reject);
    });
  },

  // 加载产品数据
  loadProduct(id) {
    const db = wx.cloud.database();
    db.collection('products')
      .doc(id)
      .get()
      .then(res => {
        const product = res.data;
        const costInfo = this.calculateProductCost(product);
        this.setData({
          product,
          costInfo
        });
      })
      .catch(err => {
        console.error('加载产品失败:', err);
        wx.showToast({
          title: '加载失败',
          icon: 'none'
        });
      });
  },

  // 加载物料数据
  loadMaterial(id) {
    const db = wx.cloud.database();
    db.collection('materials')
      .doc(id)
      .get()
      .then(res => {
        const material = res.data;
        const unitPrice = parseFloat(
          (material.spec_price / material.spec_amount).toFixed(4)
        );
        this.setData({
          material,
          unitPrice
        });
      })
      .catch(err => {
        console.error('加载物料失败:', err);
        wx.showToast({
          title: '加载失败',
          icon: 'none'
        });
      });
  },

  // 计算产品成本
  calculateProductCost(product) {
    const { materialsMap } = this.data;
    let totalCost = 0;
    const details = [];

    product.recipe.forEach(item => {
      const material = materialsMap[item.material_id];
      if (!material) return;

      const unitPrice = parseFloat(
        (material.spec_price / material.spec_amount).toFixed(4)
      );
      const itemCost = item.amount * unitPrice;

      totalCost += itemCost;
      details.push({
        materialName: material.name,
        amount: item.amount,
        unit: material.spec_unit,
        unitPrice: unitPrice,
        itemCost: parseFloat(itemCost.toFixed(2))
      });
    });

    return {
      totalCost: parseFloat(totalCost.toFixed(2)),
      details: details
    };
  },

  // 返回
  goBack() {
    wx.navigateBack();
  }
});
```

## 六、开发步骤清单

### 第一步：云数据库准备
- [ ] 创建 `materials` 集合
- [ ] 创建 `products` 集合
- [ ] 设置数据库权限（所有用户可读）
- [ ] 添加测试数据

### 第二步：页面结构搭建
- [ ] 创建 `pages/index` 目录和文件
- [ ] 创建 `pages/detail` 目录和文件
- [ ] 配置 `app.json` 页面路由
- [ ] 配置云开发环境

### 第三步：首页功能实现
- [ ] 实现数据拉取功能
- [ ] 实现物料Map索引构建
- [ ] 实现产品成本计算
- [ ] 实现搜索功能
- [ ] 实现列表渲染

### 第四步：详情页功能实现
- [ ] 实现产品详情页
- [ ] 实现物料详情页
- [ ] 实现成本明细计算
- [ ] 实现页面跳转

### 第五步：样式美化
- [ ] 首页样式
- [ ] 详情页样式
- [ ] 响应式适配
- [ ] 交互优化

### 第六步：测试和优化
- [ ] 功能测试
- [ ] 性能优化
- [ ] 错误处理
- [ ] 用户体验优化

---

**关键提示：**
1. 所有成本计算都在前端完成，不写入数据库
2. 使用 Map 索引提高物料查找效率
3. 价格修改后，用户重新进入小程序即可看到最新成本
4. 注意浮点数精度问题，使用 toFixed() 格式化

