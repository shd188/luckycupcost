# 幸运咖产品成本计算器 - 开发配置说明

## 一、云开发环境配置

### 1.1 初始化云开发

1. 在微信开发者工具中，点击"云开发"按钮
2. 开通云开发服务（如果未开通）
3. 创建云环境，记录环境ID

### 1.2 部署云函数

1. 在微信开发者工具中，右键点击 `cloudfunctions/search` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成（控制台会显示部署成功信息）

**云函数说明：**
- 云函数名称：`search`
- 功能：根据关键词搜索产品和物料
- 参数：`{ keyword: string }`
- 返回：`{ success: boolean, data: { products: [], materials: [] } }`

### 1.3 配置云环境ID

**推荐方式：自动获取环境ID（无需手动配置）**

代码已配置为自动使用当前小程序关联的云环境，无需手动填写环境ID：

```typescript
wx.cloud.init({
  traceUser: true,
})
```

**如果自动方式不行，可以手动指定环境ID：**

1. 在微信开发者工具中，点击顶部"云开发"按钮
2. 进入云开发控制台
3. 点击"设置" -> "环境设置"
4. 复制"环境ID"（格式类似：`cloud1-xxxxx`）
5. 打开 `miniprogram/app.ts`，取消注释并填写环境ID：

```typescript
wx.cloud.init({
  env: 'cloud1-xxxxx', // 替换为复制的环境ID
  traceUser: true,
})
```

**常见错误处理：**

如果遇到 `errCode: -501000` 错误：
- 检查是否已开通云开发服务
- 检查环境ID是否正确（不要有多余空格）
- 尝试使用自动获取方式（不指定 env 参数）
- 确保小程序已关联云开发环境

### 1.3 创建云数据库集合

在云开发控制台的"数据库"中创建以下集合：

#### materials 集合（物料表）

字段结构：
- `_id`: 自动生成
- `name`: String - 物料名称
- `category`: String - "material" 或 "packaging"
- `spec_amount`: Number - 规格数量
- `spec_unit`: String - 单位（"g" / "ml" / "piece"）
- `spec_price`: Number - 规格总价

#### products 集合（产品表）

字段结构：
- `_id`: 自动生成
- `name`: String - 产品名称
- `recipe`: Array - 配方数组
  - `material_id`: String - 物料ID
  - `amount`: Number - 使用量

### 1.4 设置数据库权限

在云开发控制台的"数据库"中，为两个集合设置权限：
- **读权限**：所有用户可读
- **写权限**：仅创建者可读写（管理员通过云控制台操作）

## 二、测试数据示例

### 2.1 materials 集合测试数据

```json
{
  "_id": "mat001",
  "name": "纯牛奶",
  "category": "material",
  "spec_amount": 1000,
  "spec_unit": "ml",
  "spec_price": 30.00
}
```

```json
{
  "_id": "mat002",
  "name": "咖啡豆",
  "category": "material",
  "spec_amount": 500,
  "spec_unit": "g",
  "spec_price": 25.00
}
```

### 2.2 products 集合测试数据

```json
{
  "_id": "prod001",
  "name": "拿铁咖啡",
  "recipe": [
    {
      "material_id": "mat001",
      "amount": 200
    },
    {
      "material_id": "mat002",
      "amount": 50
    }
  ]
}
```

## 三、开发调试

### 3.1 本地调试

1. 在微信开发者工具中打开项目
2. 确保已配置云环境ID
3. 确保云数据库集合已创建并添加测试数据
4. 编译运行，查看控制台日志

### 3.2 常见问题

#### 问题1：云开发未初始化
**错误信息**：`请使用 2.2.3 或以上的基础库以使用云能力`

**解决方法**：
- 检查基础库版本（建议使用最新版本）
- 确保在 `app.ts` 中正确初始化云开发

#### 问题2：数据库查询失败
**错误信息**：`数据库查询失败`

**解决方法**：
- 检查云环境ID是否正确
- 检查数据库集合名称是否正确（materials、products）
- 检查数据库权限设置
- 检查网络连接

#### 问题3：数据为空
**解决方法**：
- 在云开发控制台检查是否有测试数据
- 检查数据字段名称是否与代码一致
- 查看控制台日志，确认数据是否正确拉取

## 四、功能说明

### 4.1 首页功能
- ✅ 自动拉取物料和产品数据
- ✅ 实时计算产品成本
- ✅ 搜索功能（支持产品名称和物料名称）
- ✅ 列表展示（产品显示成本，物料显示单位成本）

### 4.2 详情页功能
- ✅ 产品详情：显示总成本和成本明细
- ✅ 物料详情：显示规格信息和单位成本

### 4.3 成本计算逻辑
- ✅ 单位成本 = 规格价格 / 规格数量
- ✅ 产品总成本 = Σ(使用量 × 单位成本)
- ✅ 所有计算在前端实时完成，不存储到数据库

## 五、部署说明

### 5.1 上传代码
1. 在微信开发者工具中点击"上传"
2. 填写版本号和项目备注
3. 上传成功后，在微信公众平台提交审核

### 5.2 发布版本
1. 登录微信公众平台
2. 进入"版本管理"
3. 选择已上传的版本，提交审核
4. 审核通过后，点击"发布"

## 六、后续优化建议

1. **性能优化**：
   - 添加数据缓存机制
   - 优化搜索性能（防抖处理）

2. **用户体验**：
   - 添加加载动画
   - 优化错误提示
   - 添加下拉刷新功能

3. **功能扩展**：
   - 添加数据导出功能
   - 添加成本趋势分析
   - 添加多门店价格对比

---

**注意事项**：
- 所有成本计算都在前端完成，不写入数据库
- 修改物料价格后，用户重新进入小程序即可看到最新成本
- 确保云数据库权限设置正确，避免数据泄露

