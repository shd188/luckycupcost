# 幸运咖产品成本计算器 - 产品设计图

## 一、系统架构图

```
┌─────────────────────────────────────────┐
│          微信小程序前端                  │
│  ┌──────────────┐  ┌──────────────┐    │
│  │  首页搜索    │  │  详情展示    │    │
│  └──────────────┘  └──────────────┘    │
│           │              │              │
│           └──────┬───────┘              │
│                  │                      │
│          ┌───────▼───────┐              │
│          │  成本计算引擎  │              │
│          │  (前端计算)    │              │
│          └───────┬───────┘              │
└──────────────────┼──────────────────────┘
                   │
                   │ 读取数据
                   │
┌──────────────────▼──────────────────────┐
│         云数据库 (CloudBase)             │
│  ┌──────────────┐  ┌──────────────┐    │
│  │  materials   │  │   products   │    │
│  │  物料表      │  │   产品表      │    │
│  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────┘
```

## 二、数据库结构设计

### 2.1 materials 集合（物料表）

```javascript
{
  _id: "自动生成",
  name: "物料名称",           // 如："牛奶"
  category: "material",      // "material" 或 "packaging"
  spec_amount: 1000,         // 规格数量，如：1000
  spec_unit: "ml",           // 单位：g / ml / piece
  spec_price: 30.00          // 规格总价，如：30元
}
```

**示例数据：**
```javascript
{
  _id: "mat001",
  name: "纯牛奶",
  category: "material",
  spec_amount: 1000,
  spec_unit: "ml",
  spec_price: 30.00
}
```

### 2.2 products 集合（产品表）

```javascript
{
  _id: "自动生成",
  name: "产品名称",          // 如："拿铁咖啡"
  recipe: [                  // 配方数组
    {
      material_id: "mat001", // 物料ID
      amount: 200            // 使用量（单位：g/ml/piece）
    },
    {
      material_id: "mat002",
      amount: 50
    }
  ]
}
```

**示例数据：**
```javascript
{
  _id: "prod001",
  name: "拿铁咖啡",
  recipe: [
    { material_id: "mat001", amount: 200 },  // 200ml 牛奶
    { material_id: "mat002", amount: 50 }    // 50ml 咖啡
  ]
}
```

## 三、页面结构设计

### 3.1 首页（index）

```
┌─────────────────────────────────────┐
│  幸运咖产品成本计算器                │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐   │
│  │  🔍 搜索产品或物料...        │   │
│  └─────────────────────────────┘   │
├─────────────────────────────────────┤
│  搜索结果列表                        │
│  ┌─────────────────────────────┐   │
│  │ ☕ 拿铁咖啡                  │   │
│  │ 💰 成本：¥8.50              │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ 🥛 纯牛奶                    │   │
│  │ 📦 1000ml / ¥30.00          │   │
│  │ 💵 单位成本：¥0.03/ml        │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

### 3.2 产品详情页（product-detail）

```
┌─────────────────────────────────────┐
│  ← 返回                              │
├─────────────────────────────────────┤
│  ☕ 拿铁咖啡                          │
│  ─────────────────────────────────   │
│  总成本：¥8.50                        │
├─────────────────────────────────────┤
│  成本明细：                           │
│  ┌─────────────────────────────┐   │
│  │ 纯牛奶                      │   │
│  │ 200ml × ¥0.03/ml = ¥6.00   │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │ 咖啡豆                      │   │
│  │ 50g × ¥0.05/g = ¥2.50      │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

### 3.3 物料详情页（material-detail）

```
┌─────────────────────────────────────┐
│  ← 返回                              │
├─────────────────────────────────────┤
│  🥛 纯牛奶                            │
│  ─────────────────────────────────   │
│  规格：1000ml                         │
│  价格：¥30.00                        │
│  ─────────────────────────────────   │
│  单位成本：¥0.03/ml                   │
│  ─────────────────────────────────   │
│  分类：原料                           │
└─────────────────────────────────────┘
```

## 四、数据流程图

### 4.1 页面加载流程

```
用户打开小程序
    │
    ▼
onLoad() 触发
    │
    ├─→ 从云数据库拉取 materials 数据
    │
    └─→ 从云数据库拉取 products 数据
            │
            ▼
        数据存储到本地 state
            │
            ▼
        渲染搜索页面（初始显示所有产品）
```

### 4.2 搜索流程

```
用户输入关键词
    │
    ▼
触发搜索函数
    │
    ├─→ 在产品列表中搜索（name 匹配）
    │
    └─→ 在物料列表中搜索（name 匹配）
            │
            ▼
        合并搜索结果
            │
            ▼
        实时计算成本（如果是产品）
            │
            ▼
        更新列表显示
```

### 4.3 成本计算流程

```
点击产品 → 进入详情页
    │
    ▼
获取产品 recipe 数组
    │
    ▼
遍历 recipe 中的每个 material_id
    │
    ├─→ 从 materials 数据中查找对应物料
    │
    ├─→ 计算单位成本：price_per_unit = spec_price / spec_amount
    │
    └─→ 计算单项成本：item_cost = amount × price_per_unit
            │
            ▼
        累加所有单项成本
            │
            ▼
        总成本 = Σ(item_cost)
            │
            ▼
        显示成本明细和总成本
```

## 五、核心计算逻辑

### 5.1 单位成本计算

```javascript
// 物料单位成本计算
function calculateUnitPrice(material) {
  return material.spec_price / material.spec_amount;
}

// 示例：
// material = { spec_price: 30, spec_amount: 1000, spec_unit: "ml" }
// unitPrice = 30 / 1000 = 0.03 (元/ml)
```

### 5.2 产品总成本计算

```javascript
// 产品总成本计算
function calculateProductCost(product, materialsMap) {
  let totalCost = 0;
  const details = [];
  
  product.recipe.forEach(item => {
    const material = materialsMap[item.material_id];
    const unitPrice = material.spec_price / material.spec_amount;
    const itemCost = item.amount * unitPrice;
    
    totalCost += itemCost;
    details.push({
      materialName: material.name,
      amount: item.amount,
      unit: material.spec_unit,
      unitPrice: unitPrice,
      itemCost: itemCost
    });
  });
  
  return {
    totalCost: parseFloat(totalCost.toFixed(2)),
    details: details
  };
}
```

## 六、页面组件结构

```
pages/
├── index/                    # 首页
│   ├── index.js
│   ├── index.wxml
│   ├── index.wxss
│   └── index.json
│
└── detail/                   # 详情页（产品/物料共用）
    ├── detail.js
    ├── detail.wxml
    ├── detail.wxss
    └── detail.json

utils/
└── calculator.js             # 成本计算工具函数
```

## 七、关键交互说明

### 7.1 搜索交互
- **触发时机**：用户输入时实时搜索（onInput）
- **搜索范围**：产品名称 + 物料名称
- **显示规则**：
  - 产品：显示名称 + 总成本
  - 物料：显示名称 + 规格 + 单位成本

### 7.2 列表项点击
- **产品项**：跳转到产品详情页，显示成本明细
- **物料项**：跳转到物料详情页，显示规格和单位成本

### 7.3 数据更新机制
- **触发时机**：每次 onLoad 时拉取最新数据
- **计算时机**：数据拉取完成后立即计算
- **缓存策略**：可考虑本地缓存，但每次进入都刷新

## 八、UI设计规范

### 8.1 颜色规范
- **主色**：咖啡色系（#8B4513）
- **辅助色**：金色（#FFD700）用于价格显示
- **背景色**：浅灰（#F5F5F5）
- **文字色**：深灰（#333333）

### 8.2 字体规范
- **标题**：32rpx，加粗
- **正文**：28rpx
- **辅助文字**：24rpx，灰色

### 8.3 间距规范
- **页面边距**：30rpx
- **列表项间距**：20rpx
- **内容区块间距**：40rpx

## 九、开发注意事项

1. **数据拉取**：使用云数据库 API，注意错误处理
2. **计算精度**：使用 toFixed(2) 保留两位小数
3. **性能优化**：物料数据可建立 Map 索引，提高查找速度
4. **权限设置**：云数据库设置为"仅创建者可读写"，管理员通过云控制台操作
5. **搜索优化**：支持模糊匹配，不区分大小写

## 十、数据结构映射关系

```
materials (物料表)
    │
    │ material_id 引用
    │
    ▼
products.recipe[] (产品配方)
    │
    │ 通过 material_id 关联
    │
    ▼
实时计算产品成本
```

---

**设计原则总结：**
- ✅ 所有成本实时计算，不存储
- ✅ 修改物料价格自动影响所有产品
- ✅ 前端纯计算，无需云函数
- ✅ 界面极简，专注查询功能
- ✅ 数据只读，无编辑入口

